### 一、软件名称

**LanLink**（局域网链接器）  
—— 寓意“通过固定域名链接局域网内设备”，既体现“局域网（Lan）”场景，又突出“链接（Link）”核心价值，简洁易记且贴合工具定位。

### 二、方案概述

LanLink 是一款**无中心节点、跨平台（Windows/Mac/Linux）**的局域网工具，基于 UDP 组播实现设备 IP 自动发现与同步，自动维护各设备的 Hosts 文件，让用户以**自定义固定域名**（如`lifeng.pc.xxx.com`）访问局域网内设备，彻底摆脱 IP 地址变化的困扰。

核心目标：**让局域网内设备通过“固定域名”无缝链接，无需记忆动态 IP**。

### 三、核心功能模块（MVP 版本）

| 模块           | 功能描述                                                        |
| -------------- | --------------------------------------------------------------- |
| 组播通信模块   | 基于 UDP 组播实现节点间消息交互（上线广播、心跳保活、离线通知） |
| Hosts 管理模块 | 自动修改 Hosts 文件，添加/更新/删除域名映射记录                 |
| 节点管理模块   | 维护局域网节点列表，检测节点上线/离线状态                       |
| 配置模块       | 读取配置文件，支持自定义域名模板和基本参数                      |
| 日志模块       | 简单日志输出到控制台和文件                                      |

### 四、整体架构

采用**分布式 P2P 模式**（无中心服务器），每个设备运行 LanLink 节点：

1. 节点启动后自动识别本机局域网 IP，按自定义规则生成唯一域名（如`{设备名}.{类型}.xxx.com`）；
2. 通过组播向局域网内所有节点广播“域名-IP”绑定信息；
3. 其他节点接收广播后，自动更新本地 Hosts 文件，添加/修改对应域名的 IP 映射；
4. 节点定时发送心跳包，超时未收到心跳则标记节点离线，自动清理 Hosts 中失效条目。

### 五、详细设计

#### 1. 组播通信设计

- **组播参数**：默认使用组播地址`239.255.0.1`、端口`9527`（可配置）
- **消息格式**（JSON）：
  ```json
  {
    "action": "heartbeat/offline", // 简化为心跳和离线两种消息
    "domain": "lifeng.pc.local", // 使用.local域
    "ip": "192.168.137.222", // 本机局域网IP
    "deviceId": "mac-001122334455", // 设备唯一标识（MAC地址）
    "hostname": "LIFENG-PC", // 主机名
    "timestamp": 1719876543 // 时间戳（秒）
  }
  ```
- **通信机制**：
  - 启动时立即发送心跳包（首次通知）
  - 每 10 秒发送一次心跳包
  - 超过 30 秒未收到心跳则判定节点离线
  - 程序退出时发送离线通知（优雅退出）

#### 2. Hosts 文件管理设计

- **路径适配**：
  - Windows：`C:\Windows\System32\drivers\etc\hosts`
  - Mac/Linux：`/etc/hosts`
- **标记区域管理**：
  ```text
  # === LanLink Managed Begin ===
  192.168.137.222  lifeng.pc.local     # LanLink
  192.168.1.101    server.dev.local    # LanLink
  # === LanLink Managed End ===
  ```
- **操作逻辑**：
  1. 首次运行时在 Hosts 文件末尾创建标记区域
  2. 所有操作仅在标记区域内进行，不影响用户自定义配置
  3. 修改前创建备份文件`hosts.bak`（仅保留最新一份）
  4. 启动时检测权限，无权限时提示并退出
- **更新策略**：
  - 新节点上线：在标记区域内添加`IP 域名 # LanLink`
  - IP 变化：更新对应域名的 IP
  - 节点离线：删除对应行

#### 3. 节点管理设计

- **设备标识**：使用主网卡 MAC 地址作为唯一设备 ID
- **节点状态**：
  ```go
  type Node struct {
      DeviceID  string    // MAC地址
      Domain    string    // 域名
      IP        string    // IP地址
      Hostname  string    // 主机名
      LastSeen  time.Time // 最后心跳时间
  }
  ```
- **域名冲突处理**：检测到相同域名不同设备 ID 时，后来者域名自动加后缀`-mac`（如`lifeng.pc-001122.local`），并在日志中警告

#### 4. 配置设计（config.json）

```json
{
  "deviceName": "", // 设备名，空则自动获取主机名
  "domainSuffix": "local", // 域名后缀
  "multicastAddr": "239.255.0.1", // 组播地址
  "multicastPort": 9527, // 组播端口
  "heartbeatInterval": 10, // 心跳间隔（秒）
  "offlineTimeout": 30, // 离线超时（秒）
  "logLevel": "info" // 日志级别：debug/info/warn/error
}
```

**域名生成规则**：`{deviceName}.{domainSuffix}`，如：`lifeng-pc.local`

### 六、使用流程

#### 1. 编译

```bash
# Windows
GOOS=windows GOARCH=amd64 go build -o lanlink.exe

# Mac (Apple Silicon)
GOOS=darwin GOARCH=arm64 go build -o lanlink

# Linux
GOOS=linux GOARCH=amd64 go build -o lanlink
```

#### 2. 配置

首次运行前，在程序同目录创建`config.json`文件（可选，使用默认配置可跳过）：

```json
{
  "deviceName": "mypc",
  "domainSuffix": "local"
}
```

#### 3. 运行

- **Windows**：右键"以管理员身份运行"`lanlink.exe`
- **Mac/Linux**：`sudo ./lanlink`

#### 4. 使用

- 程序启动后自动在后台运行，无需交互
- 使用`Ctrl+C`优雅退出（会发送离线通知）
- 查看`lanlink.log`了解运行状态
- 访问其他设备：`ping mypc.local` 或 `http://serverName.local`

### 七、技术实现要点

#### 1. 项目结构

```
LanLink/
├── main.go              // 程序入口
├── config/
│   └── config.go        // 配置读取
├── network/
│   └── multicast.go     // 组播通信
├── hosts/
│   └── manager.go       // Hosts文件管理
├── node/
│   └── manager.go       // 节点管理
└── logger/
    └── logger.go        // 日志模块
```

#### 2. 核心流程

```
启动 → 检测权限 → 加载配置 → 获取本机信息(IP/MAC/主机名)
  ↓
初始化组播监听器 ← → 发送心跳包(携带域名和IP)
  ↓
接收其他节点消息 → 更新节点列表 → 修改Hosts文件
  ↓
定时检查离线节点 → 清理Hosts文件
  ↓
退出时发送离线通知
```

#### 3. 关键依赖

- 标准库即可完成大部分功能
- 可选：`golang.org/x/net/ipv4` 用于组播操作
- 可选：`github.com/sirupsen/logrus` 用于日志

### 八、注意事项

1. **权限**：必须以管理员/root 权限运行
2. **网络**：确保局域网支持组播（大部分家庭/办公网络支持）
3. **防火墙**：需要放行 UDP 9527 端口
4. **域名**：建议使用`.local`后缀，避免与公网域名冲突
5. **唯一性**：同一局域网内避免设备名重复

### 九、后续扩展方向（V2.0）

- [ ] 多网卡支持
- [ ] 网络自动降级（组播 → 广播）
- [ ] 命令行工具（查看节点列表、测试连接）
- [ ] 系统服务安装
- [ ] Web 管理界面
- [ ] 消息加密与认证
