# LanLink 运行观测指南

## 🎯 概述

LanLink 提供多种方式监控运行状态，本文档详细说明如何观测系统是否正常工作。

---

## 📊 观测方式

### 方式一：查看日志文件 ⭐⭐⭐⭐⭐

**日志位置**：程序同目录下的 `lanlink.log`

#### 使用方法

**Windows (PowerShell):**
```powershell
# 查看完整日志
Get-Content lanlink.log

# 查看最后 20 行
Get-Content lanlink.log -Tail 20

# 实时监控日志（类似 tail -f）
Get-Content lanlink.log -Wait -Tail 10
```

**Linux/Mac:**
```bash
# 查看完整日志
cat lanlink.log

# 查看最后 20 行
tail -n 20 lanlink.log

# 实时监控日志
tail -f lanlink.log
```

#### 日志内容解读

##### 1. 启动日志

```
[2024-11-27 14:30:00] [INFO] === LanLink 启动 ===
[2024-11-27 14:30:00] [INFO] 设备名称: mypc
[2024-11-27 14:30:00] [INFO] 域名后缀: local
[2024-11-27 14:30:00] [INFO] Hosts文件初始化完成
[2024-11-27 14:30:00] [INFO] 本机信息: DeviceID=mac-00:11:22:33:44:55, IP=192.168.1.100, Domain=mypc.local
[2024-11-27 14:30:00] [INFO] 组播监听已启动: 239.255.0.1:9527
[2024-11-27 14:30:00] [INFO] LanLink 运行中，按 Ctrl+C 退出
```

✅ **说明**：系统正常启动，所有模块初始化成功

##### 2. 发现新节点

```
[2024-11-27 14:30:05] [INFO] 节点上线: server (server.local -> 192.168.1.101)
[2024-11-27 14:30:05] [INFO] 已更新hosts: server.local -> 192.168.1.101
```

✅ **说明**：发现了一个新设备 `server.local`，IP 是 `192.168.1.101`，已自动添加到 Hosts

##### 3. 节点信息更新

```
[2024-11-27 14:31:00] [INFO] 节点信息更新: server (server.local -> 192.168.1.102)
```

⚠️ **说明**：节点 IP 发生变化，已自动更新

##### 4. 节点离线

```
[2024-11-27 14:35:00] [INFO] 节点离线: server (server.local)
[2024-11-27 14:35:00] [INFO] 已删除hosts: server.local
```

⚠️ **说明**：节点超过 30 秒未发送心跳，已标记为离线并清理

##### 5. 域名冲突

```
[2024-11-27 14:30:10] [WARN] 域名冲突: mypc.local 已被占用，自动重命名为 mypc-334455.local
```

⚠️ **说明**：发现域名冲突，自动添加了 MAC 后缀

##### 6. 心跳调试信息（需要 debug 级别）

```
[2024-11-27 14:30:10] [DEBUG] 已发送心跳: mypc.local -> 192.168.1.100
[2024-11-27 14:30:15] [DEBUG] 收到消息: Action=heartbeat, From=server (192.168.1.101)
```

✅ **说明**：心跳正常发送和接收

##### 7. 错误信息

```
[2024-11-27 14:30:05] [ERROR] 更新hosts失败: permission denied
```

❌ **说明**：遇到错误，通常是权限问题

---

### 方式二：查看控制台输出 ⭐⭐⭐⭐

程序运行时，重要信息会同时输出到控制台和日志文件。

#### 正常运行的控制台输出

```
LanLink - 局域网域名自动映射工具
Version: 1.0.0

[2024-11-27 14:30:00] [INFO] === LanLink 启动 ===
[2024-11-27 14:30:00] [INFO] 设备名称: mypc
[2024-11-27 14:30:00] [INFO] Hosts文件初始化完成
[2024-11-27 14:30:00] [INFO] 本机信息: DeviceID=mac-00:11:22:33:44:55, IP=192.168.1.100, Domain=mypc.local
[2024-11-27 14:30:00] [INFO] 组播监听已启动: 239.255.0.1:9527
[2024-11-27 14:30:00] [INFO] LanLink 运行中，按 Ctrl+C 退出
LanLink 运行中，按 Ctrl+C 退出...

[2024-11-27 14:30:05] [INFO] 节点上线: server (server.local -> 192.168.1.101)
[2024-11-27 14:30:05] [INFO] 已更新hosts: server.local -> 192.168.1.101
```

✅ **说明**：看到新节点上线通知，说明系统正常工作

---

### 方式三：查看 Hosts 文件 ⭐⭐⭐⭐

直接查看系统 Hosts 文件，确认域名映射是否正确添加。

#### 查看方法

**Windows:**
```powershell
notepad C:\Windows\System32\drivers\etc\hosts
# 或
Get-Content C:\Windows\System32\drivers\etc\hosts
```

**Linux/Mac:**
```bash
sudo cat /etc/hosts
# 或
sudo less /etc/hosts
```

#### 正常的 Hosts 内容

```text
# 系统默认配置
127.0.0.1       localhost
::1             localhost

# === LanLink Managed Begin ===
192.168.1.101   server.local    # LanLink
192.168.1.102   nas.local       # LanLink
192.168.1.103   pi.local        # LanLink
# === LanLink Managed End ===

# 其他自定义配置
```

✅ **检查点**：
- 标记区域存在
- 发现的设备都在标记区域内
- IP 和域名对应正确

---

### 方式四：测试域名解析 ⭐⭐⭐⭐⭐

使用 `ping` 命令测试是否能通过域名访问其他设备。

#### Ping 测试

```bash
# 测试能否解析域名
ping server.local

# Windows 上发送 4 个包
ping -n 4 server.local

# Linux/Mac 上发送 4 个包
ping -c 4 server.local
```

#### 成功的输出

```
正在 Ping server.local [192.168.1.101] 具有 32 字节的数据:
来自 192.168.1.101 的回复: 字节=32 时间<1ms TTL=64
来自 192.168.1.101 的回复: 字节=32 时间<1ms TTL=64
来自 192.168.1.101 的回复: 字节=32 时间<1ms TTL=64
来自 192.168.1.101 的回复: 字节=32 时间<1ms TTL=64

192.168.1.101 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)
```

✅ **说明**：域名解析成功，可以正常访问

#### 失败的输出

```
Ping 请求找不到主机 server.local。请检查该名称，然后重试。
```

❌ **可能原因**：
1. 该节点未上线
2. LanLink 未正常运行
3. Hosts 文件未更新

---

### 方式五：检查进程状态 ⭐⭐⭐

确认 LanLink 进程是否在运行。

#### Windows

```powershell
# 查看进程
Get-Process lanlink

# 或使用任务管理器
tasklist | findstr lanlink
```

#### Linux/Mac

```bash
# 查看进程
ps aux | grep lanlink

# 或
pgrep -fl lanlink
```

#### 正常输出

```
 3456 lanlink.exe       0.1     15,234
```

✅ **说明**：进程正在运行，CPU 和内存占用正常（通常 < 20MB）

---

### 方式六：网络监控 ⭐⭐⭐

监控组播通信是否正常。

#### 使用 Wireshark 抓包

1. 打开 Wireshark
2. 选择你的网卡
3. 过滤器输入：`udp.port == 9527`
4. 应该能看到每 10 秒一次的心跳包

#### 使用 tcpdump (Linux/Mac)

```bash
sudo tcpdump -i any udp port 9527 -A
```

#### 正常的包内容

```
{"action":"heartbeat","domain":"mypc.local","ip":"192.168.1.100","deviceId":"mac-001122334455","hostname":"MYPC","timestamp":1732694400}
```

✅ **说明**：组播通信正常

---

## 📈 运行状态判断

### ✅ 系统正常的标志

1. **日志持续更新**
   - 每 10 秒有心跳发送记录（debug 模式）
   - 发现新节点时有上线通知

2. **Hosts 文件正确**
   - 标记区域存在
   - 发现的设备都有记录
   - IP 正确

3. **Ping 测试通过**
   - 可以 ping 通其他设备的域名
   - 域名正确解析到 IP

4. **进程运行中**
   - 进程存在
   - 内存占用正常（< 50MB）

### ⚠️ 系统异常的标志

1. **日志无更新**
   - 长时间（> 1分钟）无新日志
   - 可能原因：进程崩溃或卡死

2. **Hosts 文件未更新**
   - 标记区域为空
   - 发现的设备未添加
   - 可能原因：权限问题

3. **Ping 失败**
   - 域名无法解析
   - 可能原因：Hosts 未更新或节点离线

4. **进程不存在**
   - 找不到 lanlink 进程
   - 可能原因：程序崩溃或未启动

---

## 🛠️ 快速诊断脚本

### Windows (PowerShell)

创建 `check-status.ps1`:

```powershell
# LanLink 状态检查脚本

Write-Host "====== LanLink 状态检查 ======`n" -ForegroundColor Cyan

# 1. 检查进程
Write-Host "1. 进程状态:" -ForegroundColor Yellow
$process = Get-Process lanlink -ErrorAction SilentlyContinue
if ($process) {
    Write-Host "   ✓ 进程运行中 (PID: $($process.Id))" -ForegroundColor Green
    Write-Host "   内存占用: $([math]::Round($process.WorkingSet64/1MB, 2)) MB" -ForegroundColor Gray
} else {
    Write-Host "   ✗ 进程未运行" -ForegroundColor Red
}

# 2. 检查日志
Write-Host "`n2. 日志状态:" -ForegroundColor Yellow
if (Test-Path "lanlink.log") {
    $lastModified = (Get-Item "lanlink.log").LastWriteTime
    $secondsAgo = (Get-Date) - $lastModified
    Write-Host "   ✓ 日志文件存在" -ForegroundColor Green
    Write-Host "   最后更新: $([math]::Round($secondsAgo.TotalSeconds)) 秒前" -ForegroundColor Gray
    
    Write-Host "`n   最新日志:" -ForegroundColor Gray
    Get-Content "lanlink.log" -Tail 5 | ForEach-Object { Write-Host "   $_" -ForegroundColor Gray }
} else {
    Write-Host "   ✗ 日志文件不存在" -ForegroundColor Red
}

# 3. 检查 Hosts 文件
Write-Host "`n3. Hosts 文件:" -ForegroundColor Yellow
$hostsPath = "C:\Windows\System32\drivers\etc\hosts"
$hostsContent = Get-Content $hostsPath
$inManagedZone = $false
$managedEntries = @()

foreach ($line in $hostsContent) {
    if ($line -match "LanLink Managed Begin") {
        $inManagedZone = $true
    } elseif ($line -match "LanLink Managed End") {
        $inManagedZone = $false
    } elseif ($inManagedZone -and $line -match "^\d+\.\d+\.\d+\.\d+\s+\S+") {
        $managedEntries += $line.Trim()
    }
}

if ($managedEntries.Count -gt 0) {
    Write-Host "   ✓ 发现 $($managedEntries.Count) 个设备:" -ForegroundColor Green
    foreach ($entry in $managedEntries) {
        Write-Host "     $entry" -ForegroundColor Gray
    }
} else {
    Write-Host "   ⚠ 未发现任何设备" -ForegroundColor Yellow
}

# 4. 网络测试
Write-Host "`n4. 网络测试:" -ForegroundColor Yellow
if ($managedEntries.Count -gt 0) {
    $testEntry = $managedEntries[0] -split '\s+'
    $testDomain = $testEntry[1]
    Write-Host "   测试 $testDomain ..." -ForegroundColor Gray
    $pingResult = Test-Connection $testDomain -Count 1 -Quiet -ErrorAction SilentlyContinue
    if ($pingResult) {
        Write-Host "   ✓ Ping 成功" -ForegroundColor Green
    } else {
        Write-Host "   ✗ Ping 失败" -ForegroundColor Red
    }
} else {
    Write-Host "   ⚠ 无可测试的设备" -ForegroundColor Yellow
}

Write-Host "`n=============================" -ForegroundColor Cyan
```

运行：
```powershell
.\check-status.ps1
```

### Linux/Mac (Bash)

创建 `check-status.sh`:

```bash
#!/bin/bash

# LanLink 状态检查脚本

echo -e "\n\033[36m====== LanLink 状态检查 ======\033[0m\n"

# 1. 检查进程
echo -e "\033[33m1. 进程状态:\033[0m"
if pgrep -f lanlink > /dev/null; then
    PID=$(pgrep -f lanlink)
    MEM=$(ps -o rss= -p $PID | awk '{print $1/1024}')
    echo -e "   \033[32m✓ 进程运行中 (PID: $PID)\033[0m"
    echo -e "   \033[90m内存占用: ${MEM} MB\033[0m"
else
    echo -e "   \033[31m✗ 进程未运行\033[0m"
fi

# 2. 检查日志
echo -e "\n\033[33m2. 日志状态:\033[0m"
if [ -f "lanlink.log" ]; then
    LAST_MOD=$(stat -f %Sm -t "%Y-%m-%d %H:%M:%S" lanlink.log 2>/dev/null || stat -c %y lanlink.log 2>/dev/null)
    echo -e "   \033[32m✓ 日志文件存在\033[0m"
    echo -e "   \033[90m最后更新: $LAST_MOD\033[0m"
    echo -e "\n   \033[90m最新日志:\033[0m"
    tail -5 lanlink.log | while read line; do
        echo -e "   \033[90m$line\033[0m"
    done
else
    echo -e "   \033[31m✗ 日志文件不存在\033[0m"
fi

# 3. 检查 Hosts 文件
echo -e "\n\033[33m3. Hosts 文件:\033[0m"
HOSTS_PATH="/etc/hosts"
IN_ZONE=0
COUNT=0

while IFS= read -r line; do
    if [[ $line == *"LanLink Managed Begin"* ]]; then
        IN_ZONE=1
    elif [[ $line == *"LanLink Managed End"* ]]; then
        IN_ZONE=0
    elif [[ $IN_ZONE -eq 1 && $line =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+ ]]; then
        ((COUNT++))
        if [ $COUNT -eq 1 ]; then
            echo -e "   \033[32m✓ 发现设备:\033[0m"
        fi
        echo -e "     \033[90m$line\033[0m"
    fi
done < "$HOSTS_PATH"

if [ $COUNT -eq 0 ]; then
    echo -e "   \033[33m⚠ 未发现任何设备\033[0m"
fi

echo -e "\n\033[36m=============================\033[0m\n"
```

运行：
```bash
chmod +x check-status.sh
sudo ./check-status.sh
```

---

## 🔍 调试模式

如果需要查看更详细的运行信息，可以开启 debug 模式。

### 开启方法

修改 `config.json`:

```json
{
  "logLevel": "debug"
}
```

重启 LanLink，日志中会包含：
- 每次心跳发送的详细信息
- 收到的每条消息
- 节点列表变化
- Hosts 文件每次修改的详细过程

### Debug 日志示例

```
[2024-11-27 14:30:00] [DEBUG] 已发送心跳: mypc.local -> 192.168.1.100
[2024-11-27 14:30:05] [DEBUG] 收到消息: Action=heartbeat, From=server (192.168.1.101)
[2024-11-27 14:30:10] [DEBUG] 已发送心跳: mypc.local -> 192.168.1.100
[2024-11-27 14:30:10] [DEBUG] 检查到 0 个离线节点
```

---

## 📊 性能监控

### 正常的资源占用

| 指标 | 正常范围 | 说明 |
|------|---------|------|
| CPU | < 1% | 大部分时间处于空闲 |
| 内存 | 15-30 MB | 轻量级应用 |
| 磁盘 IO | 极低 | 仅在节点变化时写 Hosts |
| 网络 | < 1 KB/s | 每10秒约100字节 |

### 异常指标

| 指标 | 异常值 | 可能原因 |
|------|--------|---------|
| CPU | > 10% | 死循环或异常 |
| 内存 | > 100 MB | 内存泄漏 |
| 网络 | > 10 KB/s | 广播风暴 |

---

## 💡 常见问题排查

### Q: 看不到任何设备

**检查**：
1. 其他设备是否运行了 LanLink？
2. 所有设备在同一局域网？
3. 防火墙是否阻止了 UDP 9527 端口？
4. 路由器是否支持组播？

**解决**：
```bash
# Windows 防火墙规则
netsh advfirewall firewall add rule name="LanLink" dir=in action=allow protocol=UDP localport=9527

# Linux 防火墙
sudo ufw allow 9527/udp
```

### Q: 看到日志但 Hosts 未更新

**检查**：
1. 是否以管理员/root 权限运行？
2. Hosts 文件是否被其他程序锁定？
3. 日志中是否有错误信息？

### Q: Ping 域名失败

**检查**：
1. Hosts 文件中是否有该域名？
2. IP 是否正确？
3. 目标设备是否在线？
4. 网络连接是否正常？

---

## 🎯 总结

### 最常用的观测方法

1. **日常监控**：实时查看日志 `tail -f lanlink.log`
2. **快速检查**：Ping 测试 `ping device.local`
3. **详细诊断**：运行状态检查脚本
4. **深度调试**：开启 debug 模式查看详细日志

### 健康检查清单

- [ ] 进程正在运行
- [ ] 日志持续更新（< 30 秒前）
- [ ] Hosts 文件有标记区域
- [ ] 能 Ping 通其他设备的域名
- [ ] 内存占用正常（< 50MB）
- [ ] 日志无 ERROR 级别消息

---

**祝您使用愉快！** 🚀

如有问题，请查看日志文件或提交 Issue。

