# LanLink 架构说明

## 📐 设计原则

1. **不过度设计** - 专注核心功能，避免过度抽象
2. **模块化** - 清晰的模块划分，职责单一
3. **可配置** - 灵活的配置机制，适应不同场景
4. **可观测** - 完善的日志记录，便于监控和排查

## 🏗️ 项目结构

```
LanLink/
├── main.go                 # 程序入口，协调各模块
├── go.mod / go.sum         # Go 模块依赖
├── config.example.json     # 配置文件示例
├── .gitignore             
│
├── config/                 # 配置模块
│   └── config.go          # 配置加载、保存、默认值
│
├── logger/                 # 日志模块
│   └── logger.go          # 日志级别、多输出、格式化
│
├── node/                   # 节点管理模块
│   └── manager.go         # 节点增删改查、离线检测
│
├── hosts/                  # Hosts文件管理模块
│   └── manager.go         # Hosts读写、备份、标记区域管理
│
├── network/                # 网络通信模块
│   └── multicast.go       # 组播通信、消息编解码、IP获取
│
└── docs/                   # 文档
    ├── 需求文档.md
    ├── 快速开始.md
    └── 架构说明.md
```

## 🧩 模块详解

### 1. Config 模块 (config/)

**职责**：配置管理

**核心功能**：
- 从 JSON 文件加载配置
- 提供默认配置
- 自动获取主机名作为设备名

**关键设计**：
```go
type Config struct {
    DeviceName        string  // 设备名
    DomainSuffix      string  // 域名后缀
    MulticastAddr     string  // 组播地址
    MulticastPort     int     // 组播端口
    HeartbeatInterval int     // 心跳间隔
    OfflineTimeout    int     // 离线超时
    LogLevel          string  // 日志级别
}
```

**设计亮点**：
- ✅ 配置文件不存在时使用默认值，零配置启动
- ✅ 字段有明确的语义和类型
- ✅ 支持配置文件保存（未来扩展）

---

### 2. Logger 模块 (logger/)

**职责**：日志记录

**核心功能**：
- 支持 4 个日志级别（Debug/Info/Warn/Error）
- 同时输出到控制台和文件
- 带时间戳和级别标识

**关键设计**：
```go
type Logger struct {
    level  Level           // 当前日志级别
    logger *log.Logger     // 标准库logger
    file   *os.File        // 日志文件
}
```

**使用示例**：
```go
logger.Init("info", "lanlink.log")
logger.Info("节点上线: %s", nodeName)
logger.Error("连接失败: %v", err)
```

**设计亮点**：
- ✅ 简洁的API，易于使用
- ✅ 多输出目标（控制台+文件）
- ✅ 统一的日志格式

---

### 3. Node 模块 (node/)

**职责**：节点状态管理

**核心功能**：
- 维护局域网内所有节点信息
- 检测节点上线/离线
- 处理节点信息变更
- 提供变更回调机制

**关键设计**：
```go
type Node struct {
    DeviceID  string      // 唯一标识（MAC地址）
    Domain    string      // 域名
    IP        string      // IP地址
    Hostname  string      // 主机名
    LastSeen  time.Time   // 最后心跳时间
    IsLocal   bool        // 是否本机
}

type Manager struct {
    mu            sync.RWMutex              // 读写锁
    nodes         map[string]*Node          // 节点映射
    offlineTimeout time.Duration            // 离线超时
    onNodeChange  func(*Node, bool)         // 变更回调
}
```

**核心方法**：
- `AddOrUpdate()`: 添加或更新节点
- `Remove()`: 删除节点
- `CheckOffline()`: 检查并清理离线节点
- `SetChangeCallback()`: 设置变更回调

**设计亮点**：
- ✅ 线程安全（使用 RWMutex）
- ✅ 回调机制解耦业务逻辑
- ✅ 自动检测信息变更

---

### 4. Hosts 模块 (hosts/)

**职责**：Hosts文件管理

**核心功能**：
- 跨平台 Hosts 文件路径适配
- 权限检查
- 标记区域管理
- 备份机制

**关键设计**：
```go
const (
    beginMarker = "# === LanLink Managed Begin ==="
    endMarker   = "# === LanLink Managed End ==="
    entryMarker = "# LanLink"
)

type Manager struct {
    hostsPath string
}
```

**核心方法**：
- `CheckPermission()`: 检查写权限
- `Initialize()`: 初始化标记区域
- `AddOrUpdate()`: 添加/更新域名映射
- `Remove()`: 删除域名映射
- `backup()`: 备份文件

**标记区域示例**：
```text
# === LanLink Managed Begin ===
192.168.1.100  pc1.local    # LanLink
192.168.1.101  pc2.local    # LanLink
# === LanLink Managed End ===
```

**设计亮点**：
- ✅ 仅在标记区域操作，不影响用户配置
- ✅ 自动备份，安全可靠
- ✅ 跨平台路径适配

---

### 5. Network 模块 (network/)

**职责**：网络通信

**核心功能**：
- UDP 组播通信
- 消息编解码（JSON）
- 本机 IP/MAC 获取
- 消息接收回调

**关键设计**：
```go
type Message struct {
    Action    string  // heartbeat/offline
    Domain    string  // 域名
    IP        string  // IP地址
    DeviceID  string  // 设备ID
    Hostname  string  // 主机名
    Timestamp int64   // 时间戳
}

type MulticastClient struct {
    addr       string                  // 组播地址
    port       int                     // 组播端口
    conn       *net.UDPConn           // UDP连接
    packetConn *ipv4.PacketConn       // IPv4包连接
    localIP    string                  // 本机IP
    onMessage  func(*Message)          // 消息回调
}
```

**核心方法**：
- `Start()`: 启动组播监听
- `Send()`: 发送消息
- `GetMACAddress()`: 获取MAC地址
- `getLocalIP()`: 获取局域网IP

**设计亮点**：
- ✅ 使用 golang.org/x/net/ipv4 支持组播
- ✅ 自动过滤自己发送的消息
- ✅ 回调机制解耦消息处理

---

### 6. Main 模块 (main.go)

**职责**：程序入口，协调所有模块

**核心流程**：
```
1. 加载配置
2. 初始化日志
3. 检查权限
4. 获取本机信息（IP/MAC）
5. 创建各模块实例
6. 设置回调函数
7. 启动服务
8. 进入主循环
   - 定时发送心跳
   - 定时检查离线节点
   - 监听退出信号
9. 优雅退出
```

**关键函数**：
- `main()`: 主入口
- `sendHeartbeat()`: 发送心跳
- `generateDomain()`: 生成域名
- `hasDomainConflict()`: 检查域名冲突
- `extractMACShort()`: 提取MAC短格式

**设计亮点**：
- ✅ 清晰的启动流程
- ✅ 优雅退出机制（发送离线通知）
- ✅ 错误处理完善

## 🔄 数据流图

```
┌─────────────────────────────────────────────────────────────┐
│                          Main.go                             │
│  (协调层 - 负责模块初始化和生命周期管理)                      │
└─────────────────────────────────────────────────────────────┘
              │
              ├─────────────────────────────────────────┐
              │                                         │
    ┌─────────▼──────────┐                  ┌──────────▼─────────┐
    │   Config Module    │                  │   Logger Module     │
    │   (配置管理)        │                  │   (日志记录)         │
    └────────────────────┘                  └────────────────────┘
              │
              │
    ┌─────────▼──────────┐
    │  Network Module    │ ───(发送心跳)─────────────┐
    │  (组播通信)         │                            │
    └──────┬─────────────┘                            │
           │                                          │
           │(接收消息)                                 ▼
           │                                   ┌─────────────┐
           └──────────────────────────────────►│ Multicast   │
                                               │   Group     │
    ┌──────────────────┐                       │ 239.255.0.1 │
    │   Node Module    │◄──────────────────────┤   :9527     │
    │   (节点管理)      │ (消息处理)             └─────────────┘
    └────┬─────────────┘
         │
         │(节点变更回调)
         │
         ▼
    ┌──────────────────┐
    │   Hosts Module   │
    │   (Hosts管理)     │
    └──────────────────┘
         │
         │(读写)
         ▼
    ┌──────────────────┐
    │   Hosts File     │
    │ /etc/hosts 或     │
    │ C:\...\hosts     │
    └──────────────────┘
```

## 🔀 核心交互流程

### 启动流程

```
用户启动程序
    │
    ├─> 加载配置 (Config)
    │
    ├─> 初始化日志 (Logger)
    │
    ├─> 检查Hosts权限 (Hosts)
    │
    ├─> 获取本机信息 (Network.GetMACAddress, GetLocalIP)
    │
    ├─> 创建节点管理器 (Node.Manager)
    │
    ├─> 创建组播客户端 (Network.MulticastClient)
    │
    ├─> 设置回调函数
    │   ├─> 节点变更 → 更新Hosts
    │   └─> 消息接收 → 更新节点
    │
    ├─> 启动组播监听
    │
    ├─> 发送首次心跳
    │
    └─> 进入主循环
```

### 心跳流程

```
定时器触发 (每10秒)
    │
    ├─> 构造心跳消息 (Message)
    │   ├─ Action: "heartbeat"
    │   ├─ Domain: "mypc.local"
    │   ├─ IP: "192.168.1.100"
    │   ├─ DeviceID: "mac-xx:xx:xx"
    │   └─ Timestamp: 当前时间
    │
    └─> 发送到组播组 (MulticastClient.Send)
```

### 消息接收流程

```
收到组播消息
    │
    ├─> 忽略自己的消息 (IP过滤)
    │
    ├─> 解析JSON消息
    │
    ├─> 根据Action处理
    │   │
    │   ├─> heartbeat:
    │   │   ├─> 检查域名冲突
    │   │   ├─> 更新节点信息 (Node.AddOrUpdate)
    │   │   └─> 触发变更回调
    │   │       └─> 更新Hosts文件
    │   │
    │   └─> offline:
    │       └─> 删除节点 (Node.Remove)
    │           └─> 触发变更回调
    │               └─> 删除Hosts条目
```

### 离线检测流程

```
定时器触发 (每5秒)
    │
    ├─> 遍历所有节点
    │
    ├─> 检查LastSeen时间
    │
    ├─> 超过30秒未心跳?
    │   │
    │   YES─> 标记为离线
    │   │     │
    │   │     ├─> 从列表删除
    │   │     │
    │   │     └─> 触发变更回调
    │   │         └─> 删除Hosts条目
    │   │
    │   NO──> 继续
```

### 退出流程

```
用户按 Ctrl+C
    │
    ├─> 捕获信号 (SIGINT/SIGTERM)
    │
    ├─> 发送离线通知
    │   └─> Action: "offline"
    │
    ├─> 等待消息发送完成 (100ms)
    │
    ├─> 关闭组播连接
    │
    ├─> 关闭日志文件
    │
    └─> 退出程序
```

## 🎨 设计特点总结

### 1. 模块化设计
- 每个模块职责单一、边界清晰
- 模块间通过接口和回调通信，低耦合

### 2. 回调驱动
- 节点变更 → Hosts更新
- 消息接收 → 节点管理
- 事件驱动，响应式架构

### 3. 线程安全
- Node.Manager 使用 RWMutex 保护共享数据
- 并发安全的节点状态管理

### 4. 错误处理
- 每个关键操作都有错误检查
- 错误日志详细记录，便于排查

### 5. 可扩展性
- 模块化设计便于功能扩展
- 配置灵活，适应不同场景
- 预留扩展点（如多种通信模式）

## 📊 代码指标

| 模块 | 代码行数 | 核心功能数 | 复杂度 |
|------|---------|-----------|--------|
| config | ~70 | 3 | 低 |
| logger | ~90 | 5 | 低 |
| node | ~150 | 8 | 中 |
| hosts | ~190 | 7 | 中 |
| network | ~170 | 6 | 中 |
| main | ~250 | 5 | 高 |
| **总计** | **~920** | **34** | - |

## 🔮 扩展建议

### 短期优化
- [ ] 添加单元测试
- [ ] 优化日志轮转
- [ ] 添加性能监控指标

### 中期扩展
- [ ] 支持多网卡场景
- [ ] 网络自动降级（组播→广播）
- [ ] 命令行工具

### 长期规划
- [ ] Web管理界面
- [ ] 消息加密与认证
- [ ] 服务发现协议扩展

---

**架构设计理念**：简单、清晰、可靠 ✨

